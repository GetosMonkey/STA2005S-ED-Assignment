---
title: " üìä Experimental Design Project üìä"
subtitle: "STA2005S - 2025"
author: 
  - "Maryam Abrahams (ABRMAR043)"
  - "Bheka Mabika (MBKBHE002)"
format: pdf
---

# Plagiarism Statement: 

# üå∂Ô∏è Introduction:

The two chilli farmers, Ms Hopeful and Mr Growing, compete head to head for the hearts and minds of the South African chilli market. But despite their names Ms Hopeful seems to always get higher chilli yields than Mr Growing. In Mr Growing's eyes this cannot continue.

### Aim:

This experiment aims to systematically evaluate the effect of light levels, heat levels and chilli variety on crop quality and yield. With our results we will be able to give evidence-based recommendations on optimal growing conditions.

**Particularly we seek to answer:**

1.  Which light and heat settings produce the highest quality chillies?

2.  Does the above depend on variety?

3.  Does quality depend on variety?

4.  How big are the differences?

### Priori Hypothesis:

Prior to collecting the data, we hypothesize:

-   $H{1}$: Quality and yield will increase as light increases and with moderate heat levels, as either extreme of heat can lead to some form of denaturing of the plant's cells.

-   $H{2}$: Although their would be natural differences between varieties of chillies the light-heat response patterns will be similar between varieties.

-   $H{3}$: Quality of chilli would be heavily dependent on variety as taste, and look are variety-specific.

- $H{4}$: Side (North/South) has a negligible effect.

---

```{r setup, include=FALSE}

# Imports, libraries, and setup 

install.packages("EDproject_2.0.zip", repos = NULL, type = "win.binary")

library(EDproject)
library(ggplot2)
library(dplyr)
library(tidyr)
library(EDproject)
library(car)
library(knitr)

# Set global format options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 6, fig.height = 4, fig.align = "center")

# Making a color Palette for my document: 
col_palette = c (
  "#0B1D39", 
  "#333333",
  "#666666",
  "#D3D3D3",
  "#f8f8f8", 
  "#F5F5F5",
  "#007ACC",
  "#1DB954",
  "#FF6F61",
  "#f9c74f"
  
)
```

# üîç Experimental Design and Randomization:

## Simulating data:

We created the design matrix in accordance to a **Nested Latin Square design**, similar to a factorial design, however since we lack the resources needed to experiment on every possible combination, instead we pick combinations all necessary combinations needed to represent the effects of the different light and heat levels on the chillies.

**treatment factors:**

-   Light: 4 levels (1, 2, 3, 4)

-   Heat: 4 levels (1, 2, 3, 4)

$\implies 16$ unique treatments

**blocking factors:**

-   Season: (1, 2)

-   Greenhouse: (A, B)

-   Side of greenhouse: (N = north-facing, S = south-facing)

-   Chilli variety: (R = red-hot, F = furious)

![Blocking example greenhouse](Example_setup.png)

**Design:**

Within our design we have an outer $2\times2$ Latin square design, creating a 4 outer blocks separating the 4 possible combinations of the 2 greenhouses (A & B) and the 2 seasons. Each of these represents a separate experimental block.

- Block 1 = Season 1 √ó Greenhouse A\
- Block 2 = Season 1 √ó Greenhouse B\
- Block 3 = Season 2 √ó Greenhouse A\
- Block 4 = Season 2 √ó Greenhouse B

Inside each block, there is an inner $2\times2$ Latin square layer, creating a 4 block grid. The variety (*Redhot* or *Furious*) and side (*North* or *South*) were assigned according to the plan shown below:

| Side  | Variety      | Description |
|-------|--------------|-------------|
| North | Redhot (RN)  | 4 plots     |
| North | Furious (FN) | 4 plots     |
| South | Redhot (RS)  | 4 plots     |
| South | Furious (FS) | 4 plots     |

This gives 8 plots per variety and 8 plots per side in each block ‚Äî ensuring full balance within every greenhouse‚Äìseason combination.

Then, within each side-variety combination, we assign random heat and light levels. This means that Inside each block, all **16 combinations** of **Heat (H1‚ÄìH4)** and **Light (L1‚ÄìL4)** were used once, creating a full factorial of the two treatment factors.\
These 16 Heat‚ÄìLight combinations were **randomised independently** within each block to reduce bias.

The overarching structure is thus such that: Heat-Light is nested within Side-variety which are is nested Season-greenhouse combinations.

![Blocking factors Diagram](Blocking_factors_pic.png){width=60%}


### Randomization:

Each side-variety combination gets its own independent randomization of heat and light such that there is no systematic crossing of all 4 heat levels $\times$ all 4 light levels $\times$ all sides $\times$ all varieties. In this way all levels of heat and light respectively are represented in a balanced manner, but not all combinations of heat and light with the other variables are tested.

In this way there is confounding of higher order combinations but this is due to our restrictive number of available plots and resource limitations. The combination of our clever blocking within the design as well as the use of randomization mitigates the effects of this potential confounding.

### Simulation: 


The simulated quality data was generated using the **`get.observations()`** function with a fixed random seed (**`set.seed(22)`**) to ensure reproducibility.

------------------------------------------------------------------------

```{r}
set.seed(22)

# Outer Latin Square: Determines outer block position
outer_latin_square <- data.frame(
              season = c(1, 1, 2, 2),
              greenhouse = c("A", "B", "A", "B"),
              outer_block = c(1, 2, 3, 4)
)

# Assigning heat and light levels balanced
create_nested_ls <- function(block_id) {
  
  # 4 side-variety combos
  side_var_combos <- expand.grid(
    side = c("n", "s"), 
    variety = c("R", "F")
  )

  design <- data.frame()
  
  for (i in 1:nrow(side_var_combos)) {
    heat_order <- sample(1:4)
    light_order <- sample(1:4)
    combo_design <- data.frame(
      side = rep(side_var_combos$side[i], 4),
      variety = rep(side_var_combos$variety[i], 4),
      heat = heat_order,
      light = light_order
    )
    
    design <- rbind(design, combo_design)
  }
  
  return(design)
}

# Generating the design for all 4 outer blocks
all_designs <- list()

for (i in 1:nrow(outer_latin_square)){
  block_design <- create_nested_ls()
  block_design$season <- outer_latin_square$season[i]
  block_design$greenhouse <- outer_latin_square$greenhouse[i]
  block_design$outer_block <- outer_latin_square$outer_block[i]
  all_designs[[i]] <- block_design
}

# Combining blocks
final_design <- do.call(rbind, all_designs)
final_design$plot <- 1:nrow(final_design)

design_csv <- final_design[c("season", "greenhouse", "light", "heat", "variety", "side", "plot")]
```

```{r}

cat("--- Design Validation Check ---\n\n")

# unique combinations of s and gh
all_main_blocks <- unique(design_csv[, c("season", "greenhouse")])

for (i in 1:nrow(all_main_blocks)) {
  
  s <- all_main_blocks$season[i]
  gh <- all_main_blocks$greenhouse[i]
  
  cat(paste("========================================\n"))
  cat(paste("    Checking Season:", s, "| Greenhouse:", gh, " \n"))
  cat(paste("========================================\n"))
  

  current_block_data <- subset(design_csv, season == s & greenhouse == gh)
  
  side_variety_combos <- sort(unique(paste(current_block_data$side, current_block_data$variety)))
  

  for (sv in side_variety_combos) {
    cat("\n  Sub-block (Side / Variety):", sv, "\n")
    subset_data <- current_block_data[paste(current_block_data$side, current_block_data$variety) == sv, ]
    cat("    > Heat levels present: ", paste(sort(unique(subset_data$heat)), collapse=", "), "\n")
    cat("    > Light levels present:", paste(sort(unique(subset_data$light)), collapse=", "), "\n")
  }
  cat("\n")
}

cat("--- Validation Complete ---\n")

# Write file
write.csv(design_csv, "design.csv", row.names = FALSE, quote = FALSE)

```

```{r}

# Obtaining observations:
design <- read.csv("design.csv")
mydata <- get.observations(design)

mydata
```

------------------------------------------------------------------------

# üßÆ Analysis and Results:

### Fitting the models and checking assumptions:

```{r , include=FALSE}

# Convert variables to factors ---------------------------------------------
dat <- na.omit(mydata)
dat$season     <- factor(dat$season)
dat$greenhouse <- factor(dat$greenhouse)
dat$heat       <- factor(dat$heat)
dat$light      <- factor(dat$light)
dat$variety    <- factor(dat$variety)
dat$side       <- factor(dat$side)
dat$block      <- interaction(dat$season, dat$greenhouse, drop = TRUE)

# Fit model ------------------------------------------------------------------
fit <- lm(obs ~ block + heat*light*variety + side, data = dat)

# Model summary --------------------------------------------------------------
summary(fit)
```

The model uses **block** to adjust for background variation across the four Latin Square positions (the combinations of Season and Greenhouse).\

It then tests how **heat**, **light**, and **variety** affect the response and whether they interact.\

The **side** factor is included only to correct for small layout or position effects within each greenhouse.

## ANOVA:

The experiment used a **Latin Square design** with **Season √ó Greenhouse** forming the **2√ó2 blocking structure**, and a full factorial of\

**Heat (4 levels)** √ó **Light (4 levels)** √ó **Variety (2 levels)**.

The fitted linear model was:

$$
\text{obs} = \text{block} + \text{heat} \times \text{light} \times \text{variety} + \text{side}
$$

```{r, include=FALSE}
# Type I ANOVA
anova(fit)

# Type II ANOVA
Anova(fit, type = 2)
```

### Model fit

**R¬≤ = 0.968**, Adjusted **R¬≤ = 0.931** ‚Üí the model explains most of the variation in quality.\
**Residual SE = 1.76** ‚Üí small compared to the treatment range.\
No clear outliers or leverage points were found when checking diagnostic plots.\
Two coefficients were undefined because of overlap between some factors, which is expected in a full factorial design.

### Interpretation

Both **light** and **heat** increased mean quality, with **light intensity** having the strongest influence (p \< 0.001).\
**Heat** also affected quality (p \< 0.001), though to a smaller extent.\
**Variety** showed a mild difference (p = 0.018), where variety **R** performed slightly better than **F**.\
The **block** term (p = 0.0067) shows that adjusting for season and greenhouse helped control background variation.\
The **side** factor (p = 0.015) had a small effect, possibly linked to minor position or orientation differences.\
All **interaction terms** (e.g., heat √ó light) had p-values above 0.1, suggesting the effects act independently.

Overall, the results show that most of the change in quality can be explained by the main treatment factors ‚Äî especially light ‚Äî and the blocking effectively reduced environmental variation.

### Model Diagnostics

```{r diagnostics, fig.height=6, fig.width=7, fig.cap="Residual diagnostic plots showing no serious violations of model assumptions. The Q-Q plot indicates approximate normality, and the residuals vs. fitted plot shows no strong patterns suggesting heteroscedasticity."}

# Check residual assumptions -----------------------------------------------

par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))
plot(fit, which = 1, col = col_palette[1])  # Residuals vs Fitted
plot(fit, which = 2, col = col_palette[1])  # Normal Q‚ÄìQ
plot(fit, which = 3, col = col_palette[1])  # Scale‚ÄìLocation
plot(fit, which = 5, col = col_palette[1])  # Residuals vs Leverage
par(mfrow = c(1, 1))

```

Both **light** and **heat** increased mean quality, with **light intensity** having the strongest influence (p \< 0.001).

\
**Heat** also affected quality (p \< 0.001), though to a smaller extent.

**Variety** showed a mild difference (p = 0.018), where variety **R** performed slightly better than **F**.

\
The **block** term (p = 0.0067) shows that adjusting for season and greenhouse helped control background variation.

\
The **side** factor was aliased in the Type II ANOVA, meaning it was linearly dependent on other variables in the model.

\
This suggests that side orientation (north/south) did not contribute additional information once **block**, **heat**, **light**, and **variety** were included.\
Any minor variation linked to side was already captured by the blocking structure (Season √ó Greenhouse).

\
All **interaction terms** (e.g., heat √ó light) had p-values above 0.1, suggesting that the effects act independently.

## Treatment Effects Visualization:

### Interaction plots:

```{r , fig.height=6, fig.width=7, fig.cap="The following plots explore how **Heat**, **Light**, and **Variety** affect the mean chilli quality. Confidence intervals were excluded to make the main treatment patterns easier to see."}

# Interaction plots: 
par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))

# quality vs LIGHT by HEAT
interaction.plot(x.factor = dat$light, trace.factor = dat$heat, response = dat$obs,
                 fun = mean, type = "b", pch = 19,
                 xlab = "Light level", ylab = "Mean quality",
                 legend = TRUE, trace.label = "Heat")

# quality vs HEAT by LIGHT
interaction.plot(x.factor = dat$heat, trace.factor = dat$light, response = dat$obs,
                 fun = mean, type = "b", pch = 19,
                 xlab = "Heat level", ylab = "Mean quality",
                 legend = TRUE, trace.label = "Light")

# By variety
par(mfrow = c(1,2))
with(subset(dat, variety == "R"),
     interaction.plot(light, heat, obs, fun = mean, type = "b", pch = 19,
                      xlab = "Light level", ylab = "Mean quality (Variety R)",
                      legend = TRUE, trace.label = "Heat"))
with(subset(dat, variety == "F"),
     interaction.plot(light, heat, obs, fun = mean, type = "b", pch = 19,
                      xlab = "Light level", ylab = "Mean quality (Variety F)",
                      legend = TRUE, trace.label = "Heat"))
par(mfrow = c(1,1))

```

### mean plots:

```{r}

# Mean Plots

dat <- na.omit(mydata)
dat <- dat %>%
  mutate(
    heat = factor(heat),
    light = factor(light),
    variety = factor(variety)
  )

# Summary data
sumdat <- dat %>%
  group_by(light, heat, variety) %>%
  summarise(
    n = n(),
    mean = mean(obs),
    sd = sd(obs),
    se = sd / sqrt(n),
    ci = 1.96 * se,  # 95% CI
    .groups = "drop"
  )

# Mean quality by Light split by variety
ggplot(sumdat, aes(x = light, y = mean, group = heat,
                   linetype = heat, shape = heat)) +
  geom_line() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - ci, ymax = mean + ci), width = 0.15) +
  facet_wrap(~ variety) +
  labs(title = "Mean quality by Light (lines = Heat), split by Variety",
       x = "Light level", y = "Mean quality", linetype = "Heat", shape = "Heat") +
  theme_minimal(base_size = 12)


# Mean quality by Heat split by variety
ggplot(sumdat, aes(x = heat, y = mean, group = light,
                   linetype = light, shape = light)) +
  geom_line() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - ci, ymax = mean + ci), width = 0.15) +
  facet_wrap(~ variety) +
  labs(title = "Mean quality by Heat (lines = Light), split by Variety",
       x = "Heat level", y = "Mean quality", linetype = "Light", shape = "Light") +
  theme_minimal(base_size = 12)

# Mean quality by Light
ggplot(sumdat, aes(x = light, y = mean, group = interaction(heat, variety),
                   linetype = heat, shape = heat, colour = variety)) +
  geom_line() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean - ci, ymax = mean + ci), width = 0.15) +
  labs(title = "Mean quality by Light (lines = Heat; colour = Variety)",
       x = "Light level", y = "Mean quality",
       linetype = "Heat", shape = "Heat", colour = "Variety") +
  theme_minimal(base_size = 12)


```


### Analysis Procedures

**Missing Values**: Cases with missing observations were excluded from analysis using complete-case analysis, resulting in `r nrow(na.omit(mydata))` observations for model fitting.

**ANOVA**: We used Type II sums of squares to test main effects and interactions, as this approach appropriately handles unbalanced designs caused by missing data and tests each effect after accounting for all other effects at the same or lower level.

**Multiple Testing**: Given the exploratory nature of this study and the relatively small number of pre-specified hypotheses, we report both unadjusted p-values and note effects significant at Œ± = 0.05. For post-hoc pairwise comparisons, we apply Tukey's HSD adjustment.

**Model Diagnostics**: We examined residual plots (residuals vs. fitted, Q-Q plot, scale-location, and leverage plots) to verify assumptions of normality, homoscedasticity, and identify potential outliers.

**Effect Estimation**: We computed estimated marginal means (EMMs) with 95% confidence intervals for all treatment combinations.


## Optimal Conditions

```{r best-combinations}
# Find top combinations
top_combos <- sumdat %>%
  arrange(desc(mean)) %>%
  mutate(
    mean_quality = mean,
    ci_lower = mean - ci,
    ci_upper = mean + ci
  ) %>%
  head(3)

kable(top_combos[, c("variety", "light", "heat", "mean_quality", "ci_lower", "ci_upper")],
      digits = 2,
      caption = "Top three treatment combinations by mean quality score",
      col.names = c("Variety", "Light", "Heat", "Mean Quality", "CI Lower", "CI Upper"),
      align = c("l", "c", "c", "r", "r", "r"))
```

------------------------------------------------------------------------

# üßë‚Äçüåæ Conclusion:

1.  **Optimal Growing Conditions**: \[State the best combination, e.g., "Light level 4 with Heat level 3 produces the highest quality chilies"\]

2.  **Effect Sizes**: \[Quantify improvements, e.g., "The optimal combination yields quality scores approximately X points higher than standard conditions (Light 1, Heat 1), representing a Y% improvement"\]

3.  **Variety Differences**: \[Discuss whether varieties respond differently and which performs better overall\]

4.  **Interaction Effects**: \[Explain whether light and heat work synergistically or independently\]

---
# üåû Future Reccomendations:

**Primary Recommendation**: Based on this experiment, we recommend \[specific combination\] for maximizing chili quality.

**Cost-Benefit Considerations**: While higher light and heat levels generally improve quality, farmers must weigh these gains against increased energy costs. \[If results show diminishing returns, state this: "Light level 3 may offer the best cost-quality balance, as level 4 provides only marginal improvements at substantially higher cost."\]

**Variety Selection**: \[Recommend which variety to grow, or under what conditions each variety excels\]

**Practical Implementation**: - Start with \[recommended combination\] for highest quality production - If costs are prohibitive, \[alternative combination\] offers nearly comparable quality at lower expense - Monitor results and adjust based on economic returns

## Study Limitations

1.  **Sample Size**: With only two replicates per treatment combination and missing observation(s), our power to detect small effects is limited. Confidence intervals for some comparisons are wide.

2.  **Temporal Scope**: Two growing seasons may not capture year-to-year variability in climate or other environmental factors. Long-term validation is recommended.

3.  **Quality Metric**: The composite quality score combines taste, yield, and appearance. Economic returns may depend more heavily on one component (e.g., yield). Future studies should examine these components separately.

4.  **Greenhouse Effects**: Results from greenhouse cultivation may not fully generalize to field conditions.

5.  **Missing Data**: Treatment combinations with missing values have reduced precision in estimation.

## Future Directions

-   Replicate the experiment with larger sample sizes to narrow confidence intervals
-   Conduct economic analysis incorporating energy costs and market prices
-   Separate quality into components (taste, yield, appearance) for targeted optimization\
-   Test intermediate settings between levels to fine-tune recommendations
-   Evaluate performance under varying weather conditions across multiple years

------------------------------------------------------------------------

# References:

------------------------------------------------------------------------
